# AGENTS.md

## Purpose
This project is a Bun + React + Three.js web app for visualizing 3D point clouds, selecting 3D regions (prisms), and building extraction plans manually or via a genetic algorithm (GA).

## Stack and Runtime
- Runtime: Bun (`bun --hot run src/server.ts`)
- Frontend: React 19 + TypeScript + Three.js
- Backend: Bun HTTP routes + `bun:sqlite`
- Data store:
  - SQLite file for points (`DB_PATH`, default `./data/data.db`)
  - Browser `localStorage` for saved prisms/plan

## How to Run
1. Install deps: `bun install`
2. Start dev server: `bun run dev`
3. Open: `http://localhost:8080`

Optional env vars:
- `DB_PATH`: SQLite database path
- `USE_PROD=true`: switch `/points` query to `V_PRODUCTION_EVENT` instead of `MockData`

## HTTP Routes (`src/server.ts`)
- `/`: serves `src/index.html`
- `/points`: returns point data from SQLite via `getPoints()`
- `/generatePlan.worker.js`: transpiles and serves `src/generatePlan.worker.ts`
- `/generatePlan.js`: transpiles and serves `src/generatePlan.ts`
- `/test-data`: rewrites `MockData` with synthetic `w` values

Important: worker and GA modules are served through explicit transpile routes. If worker imports or paths change, update server routes accordingly.

## Architecture Map
- `src/visualiser.tsx`
  - Main orchestrator component
  - Owns scene state, region list, plan list, GA worker lifecycle
  - Connects UI overlay, plan stats, and extraction volume rendering
- `src/useVisualiserScene.ts`
  - Creates Three scene/camera/renderers/controls
  - Fetches points, recenters cloud, restores saved prisms
- `src/geometry.ts`
  - Point cloud rendering and prism geometry
  - Selection math (`getPointsInScreenSelection`, `getPointsInPrism`)
  - Prism snapshot serialization helpers
- `src/planStats.ts`
  - Computes per-plan-item extracted results and grand totals
  - Computes valid start angles for each region
- `src/generatePlan.ts`
  - Pure GA search implementation
- `src/generatePlan.worker.ts`
  - Worker wrapper around GA with progress/done messages
- `src/overlay.tsx`, `src/RegionTab.tsx`, `src/PlanTab.tsx`, `src/OperationPlan.tsx`
  - UI controls for regions and plan editing/generation
- `src/storage.ts`
  - `localStorage` schema and validation
- `src/points.ts`, `src/db.ts`, `src/testData.ts`
  - SQLite access and test data generation

## Core Data Flow
1. Client loads `Visualiser`.
2. Scene hook fetches `/points`, recenters points, draws clouds.
3. Stored prisms/plan are hydrated from `localStorage`.
4. User creates regions via Shift+drag screen selection -> prism generation.
5. Plan items are edited manually or generated by GA worker.
6. `computePlanStats()` recomputes extraction outcomes and validity flags.
7. `usePlanExtractionVolumes()` overlays extraction prism volumes in scene.

## Persistence Contracts
- Prisms key: `rom-vis-web.prisms.v1`
- Plan key: `rom-vis-web.plan.v1`
- Both payloads are versioned (`version: 1`) and runtime-validated on load.
- Any schema changes should:
  - Bump key/version
  - Add migration or safe fallback behavior

## Conventions and Guardrails
- Coordinates are recentered for rendering; metadata converts back using `pointOffset`.
- Region selection is `Shift + drag` only.
- Region and plan identity uses UUIDs (`crypto.randomUUID()`).
- Angle handling is normalized/clamped; quantities are integer, non-negative.
- Plan stats are derived state; avoid duplicating extraction logic in UI.

## Known Hotspots / Gotchas
- `visualiser.tsx` is large and state-heavy; keep new logic in hooks/util modules.
- Worker cancellation currently uses terminate-and-recreate in UI path; ensure runId checks remain consistent.
- `generatePlan.worker.ts` dynamically imports `/generatePlan.js`; route/path mismatch will silently break generation.
- `testData.ts` insert loop skips records when `w` is falsy (`if (!point || !w) continue;`), which drops valid `w=0` values.
- No test suite is currently configured; verify critical flows manually after changes.

## Manual Verification Checklist
- App loads and renders point cloud.
- Shift+drag creates region prism and region list item.
- Region rename, selection, and delete all work.
- Plan item add/edit/delete updates extraction totals.
- GA generate/stop works; progress appears; final plan is applied.
- Refresh preserves prisms and plan from `localStorage`.
- `/test-data` still populates `MockData` as expected when used.

## Suggested Refactor Targets
- Split `visualiser.tsx` into smaller hooks (worker orchestration, plan actions, region actions).
- Add unit tests for:
  - `computePlanStats()`
  - `computeValidStartAnglesForRegion()`
  - `generatePlan()` scoring and constraints
- Add integration test coverage for worker message protocol (`ready/progress/done`).
